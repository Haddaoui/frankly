<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">


<dom-module id="dash-board">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        background: white;
        font-family: 'Roboto', 'Noto', sans-serif;
      }

      .horizontal {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .justified {
        @apply(--layout-justified);
      }

      paper-toolbar {
        background-color: var(--paper-blue-grey-50);
        color: var(--paper-blue-grey-700);
        --paper-toolbar-title: {
          margin: 20px;
        }
      }

      paper-button {
        text-transform: none;
        margin: 0;
      }

      a:link, a:visited {
        text-decoration: none;
        color: var(--google-blue-700);
      }

      .avatar {
        border-radius: 50%;
        width: 36px;
        height: 36px;
        vertical-align: middle;
        margin-left: 16px;
      }

      .octocat-icon { fill: var(--paper-blue-grey-700); }
      .divider { padding: 0 0 0 16px; }

      .login-placeholder {
        max-width: 500px;
        text-align: center;
        margin: 100px auto;
      }

      /*.p0 { color: var(--paper-pink-500) !important; }
      .p1 { color: var(--paper-orange-500) !important; }
      .p2 { color: var(--paper-indigo-500) !important; }
      .pr { color: var(--paper-green-500) !important; }*/

      .tldr {
        text-align: center;
        margin: 0 20px;
      }
      .tldr .value {
        font-size: 60px;
        line-height: 1;
        font-weight: 700;
      }
      .tldr .title {
        font-size: 15px;
        font-weight: 300;
        text-transform: uppercase;
      }

      .status {
        text-align: center;
        margin: 20px 0;
      }

      .container {
        max-width: 600px;
        margin: 40px auto;
      }

      .summary {
        @apply(--layout-wrap);
      }

      .row {
        @apply(--layout-horizontal);
        font-size: 16px;
        padding: 10px 0;
        border-bottom: 1px solid #EFF0EC;
      }

      .count {
        width: 100px;
      }
      .name {
        width: 300px;
      }
    </style>

    <paper-toolbar>
      <span class="title">[[header]]</span>

      <div hidden$="[[!githubUser]]">
        <span>{{githubUser.github.displayName}}</span>
        <img class="avatar" alt="github avatar" src="[[githubUser.github.profileImageURL]]">
        <span class="divider">|</span>
      </div>

      <paper-button on-tap="_onLoginTap">
        {{_buttonText(githubUser)}}
        <svg class="octocat-icon" hidden$="[[githubUser]]" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59 0.4 0.07 0.55-0.17 0.55-0.38 0-0.19-0.01-0.82-0.01-1.49-2.01 0.37-2.53-0.49-2.69-0.94-0.09-0.23-0.48-0.94-0.82-1.13-0.28-0.15-0.68-0.52-0.01-0.53 0.63-0.01 1.08 0.58 1.23 0.82 0.72 1.21 1.87 0.87 2.33 0.66 0.07-0.52 0.28-0.87 0.51-1.07-1.78-0.2-3.64-0.89-3.64-3.95 0-0.87 0.31-1.59 0.82-2.15-0.08-0.2-0.36-1.02 0.08-2.12 0 0 0.67-0.21 2.2 0.82 0.64-0.18 1.32-0.27 2-0.27 0.68 0 1.36 0.09 2 0.27 1.53-1.04 2.2-0.82 2.2-0.82 0.44 1.1 0.16 1.92 0.08 2.12 0.51 0.56 0.82 1.27 0.82 2.15 0 3.07-1.87 3.75-3.65 3.95 0.29 0.25 0.54 0.73 0.54 1.48 0 1.07-0.01 1.93-0.01 2.2 0 0.21 0.15 0.46 0.55 0.38C13.71 14.53 16 11.53 16 8 16 3.58 12.42 0 8 0z" />
        </svg>
      </paper-button>
    </paper-toolbar>

    <div class="login-placeholder" hidden$="[[githubUser]]">
      <h1><span style="font-weight:normal; font-size: 70px;">ðŸ™€</span></h1>
      <h1>You're not signed in!</h1>
      <p>You need to sign it with GitHub for this to work.</p>
    </div>

    <div class="container">
      <div class="horizontal justified summary" style="vertical-align:bottom">
        <div class="tldr">
          <div class="value">{{all.prs.length}}</div>
          <div class="title">PRs</div>
        </div>
        <div class="tldr">
          <div class="value">{{all.issues.length}}</div>
          <div class="title">Issues</div>
        </div>
        <div class="tldr">
          <div class="value">{{all.untriaged.length}}</div>
          <div class="title">Untriaged</div>
        </div>
        <template is="dom-repeat" items="{{all.labels}}">
          <div class="tldr">
            <div class="value">{{item.items.length}}</div>
            <div class="title">{{item.name}}</div>
          </div>
        </template>
      </div>

      <div class="status">Status: {{status}}</div>

      <div class="row header">
        <div class="name">Repository</div>
        <div class="count">Issues</div>
        <div class="count">Untriaged</div>
        <div class="count">PR's</div>
        <template is="dom-repeat" items="{{labels}}">
          <div class="count">{{item}}</div>
        </template>
      </div>
      <template is="dom-repeat" items="{{byRepo}}">
        <div class="row repo">
          <div class="name"><a target="_blank" href="https://github.com/{{organization}}/{{item.name}}">{{item.name}}</a></div>
          <div class="count"><a class="pr" target="_blank" href="https://github.com/{{organization}}/{{item.name}}/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen">{{item.issues}}</a></div>
          <div class="count"><a class="pr" target="_blank" href="https://github.com/{{organization}}/{{item.name}}/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+no%3Alabel+">{{item.untriaged}}</a></div>
          <div class="count"><a class="pr" target="_blank" href="https://github.com/{{organization}}/{{item.name}}/pulls?utf8=%E2%9C%93&q=is%3Apr+is%3Aopen">{{item.prs}}</a></div>

          <template is="dom-repeat" items="{{byRepo.labels}}" as="labelItem">
            <div class="count"><a class="pr" target="_blank" href="https://github.com/{{organization}}/{{item.name}}/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+label%3A{{labelItem.name}}+">{{labelItem.count}}</a></div>
          </template>
          <div class="count" hidden$="[[!travisBadge]]"><a target="_blank" href="https://travis-ci.org/{{organization}}/{{item.name}}"><img src="https://travis-ci.org/{{organization}}/{{item.name}}.svg?branch=master"></a></div>
        </div>
      </template>

    </div>

    <firebase-auth provider="github" id="githubAuth"
      location="https://grilled-cheese.firebaseio.com"
      user="{{githubUser}}">
    </firebase-auth>
  </template>

  <script>
    Polymer({
      is: 'dash-board',

      properties: {
        header: {
          type: String
        },

        githubUser: {
          type: Object
        },

        organization: {
          type: String
        },

        repos: {
          type: Array
        },

        labels: {
          type: Array
        },

        travisBadge: {
          type: Boolean,
          value: false
        },

        fullRepoNames: {
          type: Boolean
        }
      },

      observers: [
        '_refresh(githubUser)'
      ],

      refresh: function() {
        this._refresh(this.githubUser);
      },

      _buttonText: function(user) {
        return user ? 'Sign out' : 'Sign in with GitHub';
      },

      _onLoginTap: function() {
        if (this.githubUser) {
          this.$.githubAuth.logout();
        } else {
          this.$.githubAuth.login();
        }
      },

      _refresh: function(user) {
        if (!this.organization)
          this.organization = user.github.username;

        // We want to incrementally fetch each repo, rather than block while
        // waiting on all of them, so create a queue of repos we care about.
        var requestQueue = [];

        for (var i = 0; i < this.repos.length; i++ ) {
          requestQueue.push(this.repos[i]);
        }

        this.all = {};
        this.set(['byRepo'], []);
        this.set(['all', 'labels'], []);
        this._requestQueue = requestQueue;
        this._makeNextRequest();
      },

      _makeNextRequest: function() {
        var repo = this._requestQueue[0];

        if (!repo) {
          this.status = 'Idle';
          return;
        }

        // We may have made a paginated request, in which case we added the
        // page as the 'next' property.
        var name = this.fullRepoNames ? repo : this.organization + '/'+ repo;
        var base = repo.next || 'https://api.github.com/repos/' + name + '/issues?state=open';
        var url = base + '&access_token=' + this.githubUser.github.accessToken;

        // Make request!
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.send();

        this.status = 'Fetching issues for \'' + name + '\'';

        xhr.addEventListener("load", function() {
          this._handleResponse(xhr, repo);
        }.bind(this));
        xhr.addEventListener("error", function() {
          this.status = 'Error: ' + xhr.status;
          this.shift('_requestQueue');
          this._makeNextRequest();
        }.bind(this));
      },

      _handleResponse: function(xhr, repo) {
        if (xhr.status/100 != 2) {
          this.status = 'Error: ' + xhr.status;
          this.shift('_requestQueue');
          this._makeNextRequest();
        } else {
          var response = JSON.parse(xhr.responseText);

          var repoIssues = this._getAllIssues(response);
          var repoUntriaged = this._filterIssuesByLabel(response, /^.+/i, true);
          var repoPRs = this._getAllPRs(response);
          var repoSummary = {'name': repo,
                             'issues': repoIssues.length,
                             'untriaged': repoUntriaged.length,
                             'prs': repoPRs.length,
                             'labels': []
                            };
          var repoLabelSummary = [];

          // Add to the total summary.
          this._updateModelPath(['all', 'issues'], repoIssues);
          this._updateModelPath(['all', 'untriaged'], repoUntriaged);
          this._updateModelPath(['all', 'prs'], repoPRs);

          // Add to the total summary by label.
          for (var i = 0; i < this.labels.length; i++) {
            var regex = new RegExp('^' + this.labels[i], 'i');
            var items = this._filterIssuesByLabel(response, regex, false);
            repoLabelSummary.push({'name': this.labels[i], 'count': items.length});

            // Ugh I think this can be maybe done with paths, but I suck at paths.
            // Does this label already exist?
            if (this.all.labels[i]) {
              // Merge the numbers! ???
              this._updateModelPath(['this.all.labels[i].items'], items);
            } else {
              this.push('all.labels', {'name': this.labels[i], 'items': items});
            }
          }

          // Assemble the row view.
          var index = this.byRepo.length;
          this.push('byRepo', repoSummary);
          // ???
          this.set(['byRepo', 'labels'], repoLabelSummary);
          this.set('byRepo.0.labels', repoLabelSummary);

          // Yay for pagination!
          var link = xhr.getResponseHeader('Link');
          var matches = link && link.match(/<([^>]*)>; rel="next"/);
          repo.next = matches && matches[1];
          if (!repo.next) {
            this.shift('_requestQueue');
          }
          this._makeNextRequest();
        }
      },

      _getAllIssues: function(items) {
        items = items.filter(function(item) {
          return Boolean(item.pull_request) === false;
        });
        return items;
      },

      _getAllPRs: function(items) {
        items = items.filter(function(item) {
          return Boolean(item.pull_request) === true;
        });
        return items;
      },

      _filterIssuesByLabel: function(items, label, negate) {
        items = this._getAllIssues(items);

        items = items.filter(function(item) {
          var matches = false;
          for (var i = 0; i < item.labels.length; i++) {
            if (item.labels[i].name.match(label)) {
              matches = matches || true;
            }
          }
          return negate ? !matches : matches;
        });
        return items;
      },

      _updateModelPath(path, newItems) {
        var currentItems = this.get(path) || [];
        this.set(path, currentItems.concat(newItems));
      }
    });
  </script>
</dom-module>
